"use strict";(self.webpackChunkmaltsev_space=self.webpackChunkmaltsev_space||[]).push([[473],{6753:function(n,a,e){e.d(a,{nC:function(){return s},$y:function(){return t},fL:function(){return o}});e(358);var s="_14sfvu70",t="_14sfvu72",o="_14sfvu71"},7400:function(n,a,e){e.r(a),e.d(a,{Head:function(){return d},default:function(){return h}});var s=e(1151),t=e(7294);function o(n){const a=Object.assign({h2:"h2",a:"a",span:"span",ol:"ol",li:"li",strong:"strong",p:"p",em:"em"},(0,s.ah)(),n.components);return t.createElement(t.Fragment,null,t.createElement(a.h2,{id:"disclaimer",style:{position:"relative"}},t.createElement(a.a,{href:"#disclaimer","aria-label":"disclaimer permalink",className:"anchor before"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Disclaimer"),"\n",t.createElement(a.ol,null,"\n",t.createElement(a.li,null,"This article shows how to simulate dictionary behavior with generic static classes. However, ",t.createElement(a.strong,null,"the way to this solution goes through other examples with lots of design details"),' to make you familiar with the situation. If you\'re interested only in "hacking" part, you may go directly to the section ',t.createElement(a.a,{href:"#implementing-a-generic-based-cached-producer"},"Implementing a generic-based cached producer"),"."),"\n",t.createElement(a.li,null,"In code examples I've used ",t.createElement(a.strong,null,"Nullable Reference Types"),", which is a new feature from ",t.createElement(a.strong,null,"C# 8"),". They don't affect the performance and definitely not a main point of the article. If you're curious, check the ",t.createElement(a.a,{href:"https://docs.microsoft.com/en-us/dotnet/csharp/nullable-references"},"documentation"),"."),"\n",t.createElement(a.li,null,"All code is available on ",t.createElement(a.a,{href:"https://github.com/AxelUser/examples/tree/master/DotNet/DictionaryOfTypes"},"GitHub"),"."),"\n"),"\n",t.createElement(a.h2,{id:"task-create-a-factory-for-rest-clients",style:{position:"relative"}},t.createElement(a.a,{href:"#task-create-a-factory-for-rest-clients","aria-label":"task create a factory for rest clients permalink",className:"anchor before"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Task: create a factory for REST clients"),"\n",t.createElement(a.p,null,"When you are integrating different services into each other, it's always a very time-consuming process to write clients for all of them. Luckily, if those RESTful services provide their API schema in ",t.createElement(a.strong,null,"OpenAPI")," (or previously named ",t.createElement(a.strong,null,"Swagger"),") format, chances are great that there's a generator of clients for this common type of schema format."),"\n",t.createElement(a.p,null,".Net has several packages for client generation, for example ",t.createElement(a.a,{href:"https://github.com/RicoSuter/NSwag"},"NSwag"),". There are different opinions on how generated clients should be look like, but let's consider that their constructors receive ",t.createElement(a.em,null,"HttpClient")," instance for sending requests and classes themselves are derived from generated interfaces, containing all public methods for the API."),"\n",t.createElement(a.p,null,"The first requirement helps to manipulate ",t.createElement(a.em,null,"HttpClient")," creation and lifetime, which means that we can even reuse one from the pool. The second requirement will be handy, when it's needed to write unit-tests for code, that uses service's clients - in that case they must be mocked and mocking in .Net's frameworks \"mostly\" requires passing an interface."),"\n",t.createElement(a.p,null,"To sum everything up, the generated code will follow the similar pattern:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">interface</span> <span class="token class-name">ISomeResourceClient</span>\n<span class="token punctuation">{</span>\n\t<span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>SwaggerResponse<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetSomeResourceAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">SomeResourceClient</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ISomeResourceClient</span></span>\n<span class="token punctuation">{</span>\n\t<span class="token keyword">private</span> <span class="token class-name">HttpClient</span> _httpClient<span class="token punctuation">;</span>\n\n\t<span class="token keyword">public</span> <span class="token function">SystemClient</span><span class="token punctuation">(</span><span class="token class-name">HttpClient</span> httpClient<span class="token punctuation">)</span>\n\t<span class="token punctuation">{</span>\n\t\t_httpClient <span class="token operator">=</span> httpClient<span class="token punctuation">;</span>\n\t<span class="token punctuation">}</span>\n\n\t<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>SwaggerResponse<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetUpdaterLinkAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span>\n\t<span class="token punctuation">{</span>\n\t\t<span class="token comment">// Generated code for sending request.</span>\n\t<span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.h2,{id:"automating-client-creation",style:{position:"relative"}},t.createElement(a.a,{href:"#automating-client-creation","aria-label":"automating client creation permalink",className:"anchor before"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Automating client creation"),"\n",t.createElement(a.p,null,"Although clients are implementing their own interfaces, it's still hard to test code, that creates clients via constructors. For a testable code it's required to have all those clients as dependencies or delegate their creation into a new dependency. It's possible to resolve clients via ",t.createElement(a.strong,null,"Dependency Injection"),", because ",t.createElement(a.em,null,"HttpClient")," can be effectively taken from reusable pool via ",t.createElement(a.a,{href:"https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests"},"IHttpClientFactory"),", and most of the DI frameworks offer you a zero configuration for that feature."),"\n",t.createElement(a.p,null,"However sometimes it's necessary to control base url to your service or to dynamically pass some values into request's headers, like authorization tokens or distributed tracing ids. So it may be preferred to pass a valid ",t.createElement(a.em,null,"HttpClient")," manually and that's why for the sake of the article let's stick to this format."),"\n",t.createElement(a.p,null,"The most appropriate way of extracting object construction into dedicated dependency is implementing a ",t.createElement(a.a,{href:"https://refactoring.guru/design-patterns/factory-method"},"Factory")," for clients. Unfortunately, all clients implement different interfaces and it isn't possible to write base interface as returned value for the factory method. However it's still possible to invoke the creation of specific client by redesigning the factory into generic class."),"\n",t.createElement(a.p,null,"Let's discuss possible interface:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IClientFactory<span class="token punctuation">&lt;</span><span class="token keyword">out</span> T<span class="token punctuation">></span></span> <span class="token keyword">where</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>\n<span class="token punctuation">{</span>\n    <span class="token return-type class-name">T</span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token class-name">HttpClient</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Why it's preferred to make whole class as generic and not just the method ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Create</code>'}}),"? If it will be only a generic method, the factory will be similar to the ",t.createElement(a.a,{href:"https://blog.ploeh.dk/2010/02/03/ServiceLocatorisanAnti-Pattern/"},"Service Locator"),", which has some maintainability issues and hides the information which clients the outer code depends on."),"\n",t.createElement(a.p,null,"Here is an example:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token function">Wrapper</span><span class="token punctuation">(</span>\n    <span class="token class-name">IClientFactory<span class="token punctuation">&lt;</span>ISomeResourceClient<span class="token punctuation">></span></span> concreteClientFactory<span class="token punctuation">,</span> <span class="token comment">// doesn\'t hide details</span>\n    <span class="token class-name">IClientFactory</span> commonClientFactory<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token comment">// some ctor details</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"The first variant of ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">concreteClientFactory</code>'}})," is much more transparent than ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">commonClientFactory</code>'}}),". ",t.createElement(a.strong,null,"That's why this design will be applied to all further solutions it the article.")),"\n",t.createElement(a.p,null,"As factory should create clients of specific types, there are some more questions to discuss:"),"\n",t.createElement(a.ol,null,"\n",t.createElement(a.li,null,"How factory should invoke a constructor of the concrete client?"),"\n",t.createElement(a.li,null,"How factory should effectively guess object of which class should be created, if only interface is passed to the generic type parameter?"),"\n"),"\n",t.createElement(a.p,null,"Solution for the first question is quite trivial - invoking constructor via handy static helper ",t.createElement(a.a,{href:"https://docs.microsoft.com/en-gb/dotnet/api/system.activator.createinstance?view=netcore-3.1#System_Activator_CreateInstance_System_Type_System_Object___"},"Activator.CreateInstance"),". Internally it's an old friend reflection does all the job, but activator provides a simpler API."),"\n",t.createElement(a.p,null,"For the second problem another reflection-based mechanism should be involved. As I mentioned above, mocking frameworks for .Net work better, if they create mocks that implement base interfaces. Thus the factory method should expose client's interface in returned value. It can be easily achieved with the help of generic type parameter, but nevertheless factory method should create an object of the concrete class."),"\n",t.createElement(a.p,null,"So, factory should perform mapping between the interface and the implementation. Fortunately, all generated classes and interfaces are stored under dedicated namespace and are available during the start of an application. That's right - ",t.createElement(a.strong,null,"mapping can be created by traversing though all classes in that namespace"),"."),"\n",t.createElement(a.p,null,"To execute search only once, it's better to put mapping code into a ",t.createElement(a.strong,null,"static constructor"),". Reflection will traverse through the whole assembly, find all client's interfaces with their implementations and save that relationships into a simple dictionary. Also it'a a good idea to ",t.createElement(a.strong,null,"encapsulate mapping into another dependency"),", which has private static field with that dictionary and produces the factory for required clients. Encapsulation will protect internal mapping from unexpected mutations and make namespace cleaner."),"\n",t.createElement(a.p,null,"The new dependency can be implemented as a factory provider, or in other words factory of factories. The interface is trivial:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IClientsFactoryProvider</span>\n<span class="token punctuation">{</span>\n    <span class="token return-type class-name">IClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">GetClientFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Type of the client's implementation can be passed into client factory constructor by factory provider. Thus, after factory provider is invoked, it finds relevant class for an interface passed as generic type argument and creates the valid client factory. Below is the implementation of the provider:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleClientFactoryProvider</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IClientsFactoryProvider</span></span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>Type<span class="token punctuation">,</span> Type<span class="token punctuation">></span></span> DiscoveredAllowedClientTypes<span class="token punctuation">;</span>\n\n    <span class="token keyword">static</span> <span class="token function">SimpleClientFactoryProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        DiscoveredAllowedClientTypes <span class="token operator">=</span> <span class="token function">GetAllTypes</span><span class="token punctuation">(</span>Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">ToDictionary</span><span class="token punctuation">(</span>tuple <span class="token operator">=></span> tuple<span class="token punctuation">.</span>@<span class="token keyword">interface</span><span class="token punctuation">,</span> tuple <span class="token operator">=></span> tuple<span class="token punctuation">.</span>implementation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token return-type class-name">IClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">GetClientFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>DiscoveredAllowedClientTypes<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> implType<span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Client type \'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">\' isn\'t supported"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span>implType<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token punctuation">(</span>Type @<span class="token keyword">interface</span><span class="token punctuation">,</span> Type implementation<span class="token punctuation">)</span><span class="token punctuation">></span></span> <span class="token function">GetAllTypes</span><span class="token punctuation">(</span><span class="token class-name">Assembly</span> assembly<span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token class-name"><span class="token keyword">var</span></span> clientsTypes <span class="token operator">=</span> assembly<span class="token punctuation">.</span>DefinedTypes\n            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>type <span class="token operator">=></span> type<span class="token punctuation">.</span>CustomAttributes\n                <span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>attr <span class="token operator">=></span> attr<span class="token punctuation">.</span>AttributeType <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">RestClientAttribute</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> clientType <span class="token keyword">in</span> clientsTypes<span class="token punctuation">)</span>\n        <span class="token punctuation">{</span>\n            <span class="token class-name"><span class="token keyword">var</span></span> @<span class="token keyword">interface</span> <span class="token operator">=</span> clientType<span class="token punctuation">.</span>ImplementedInterfaces<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>@<span class="token keyword">interface</span><span class="token punctuation">,</span> clientType<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Everything is done so far. All mapping is extracted into provider, which had permitted the easier implementation of the actual client factory:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Type</span> _clientImplType<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token function">ClientFactory</span><span class="token punctuation">(</span><span class="token class-name">Type</span> clientImplType<span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        _clientImplType <span class="token operator">=</span> clientImplType<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token return-type class-name">T</span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token class-name">HttpClient</span> client<span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>_clientImplType<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Now it's time to ask, ",t.createElement(a.strong,null,"what can be done to produce factories more efficiently"),". If factory creation will be done very often, it's better to make some kind of caching for it, because it doesn't depend on a context of invocation."),"\n",t.createElement(a.p,null,"I want to mention, that all modern DI frameworks has an ability to mark those client factories as singletons at configuration and that's OK to use it when you can."),"\n",t.createElement(a.p,null,"Even so, what about making this mechanism by ourselves? If you're interested, I'll welcome you to read the article further."),"\n",t.createElement(a.h2,{id:"benchmarking",style:{position:"relative"}},t.createElement(a.a,{href:"#benchmarking","aria-label":"benchmarking permalink",className:"anchor before"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Benchmarking"),"\n",t.createElement(a.p,null,"Before we dig into optimizations, ",t.createElement(a.strong,null,"it's HIGHLY recommended to track the performance of made solutions"),". As we are dealing with isolated modules, micro-benchmarking will suit our needs."),"\n",t.createElement(a.p,null,"The easiest way to create benchmarks of that kind is using a popular nuget package ",t.createElement(a.a,{href:"https://benchmarkdotnet.org/"},"BenchmarkDotNet"),". I won't include in the article how to write good benchmarks for every situation, because this theme is quite vast. However, if you're not familiar with benchmarking or BenchmarkDotNet, you may follow the links to BenchmarkDotNet documentation at the section ",t.createElement(a.strong,null,"References"),"."),"\n",t.createElement(a.p,null,"Frankly speaking, I shall mention that maintainers of the BenchmarkDotNet did a great job in providing an easy API for creating benchmarks, which gives ability to include lots of useful indicators and will be clear to the most of .Net developers."),"\n",t.createElement(a.p,null,"Firstly we need to know how solutions are fast and how much memory they consume. In BenchmarkDotNet speed indicator come out of the box, and memory consumption can be tracked via ",t.createElement(a.a,{href:"https://adamsitnik.com/the-new-Memory-Diagnoser/"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">MemoryDiagnoser</code>'}}))," attribute for the benchmark class. Here is a code snippet of configuration:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MemoryDiagnoser</span></span><span class="token punctuation">]</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientFactoryProvidersBenchmark</span>\n<span class="token punctuation">{</span>\n\t<span class="token comment">// Benchmarks</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Now it's time for benchmarks themselves. ",t.createElement(a.strong,null,"Caching improves peeking of some value many times"),", that's why benchmark should also perform several attempts of getting factories for each client."),"\n",t.createElement(a.p,null,"To show how many attempts were performed, BenchmarkDotNet has an ability to use custom benchmark parameters via another attribute ",t.createElement(a.a,{href:"https://benchmarkdotnet.org/articles/features/parameterization.html"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Params</code>'}})),". It receives values of that parameter for each benchmark run and displays that value at its own column in report. For this benchmark let's choose numbers ",t.createElement(a.em,null,"100"),", ",t.createElement(a.em,null,"1000")," and ",t.createElement(a.em,null,"10000000"),":"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Params</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">10000000</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>\n<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Accesses <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Another useful feature is making benchmark for original solution as ",t.createElement(a.a,{href:"https://benchmarkdotnet.org/articles/features/baselines.html"},"baseline"),". It is used to display the ratio of how speed of other benchmarks differs from the baseline."),"\n",t.createElement(a.p,null,"Alright, now everything is ready to write the code of the first benchmark:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Benchmark</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Baseline <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>\n<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SimpleFactory_SequentialAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token function">Execute</span><span class="token punctuation">(</span>_simpleFactoryRunActions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MethodImpl</span><span class="token attribute-arguments"><span class="token punctuation">(</span>MethodImplOptions<span class="token punctuation">.</span>AggressiveInlining<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>\n<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">IReadOnlyList<span class="token punctuation">&lt;</span>Action<span class="token punctuation">></span></span> actions<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token class-name"><span class="token keyword">var</span></span> length <span class="token operator">=</span> actions<span class="token punctuation">.</span>Count<span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Accesses<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        actions<span class="token punctuation">[</span>i <span class="token operator">%</span> length<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Well, that code is strange. It's because I've generated all actual invocations of factory provider using ",t.createElement(a.strong,null,"T4")," template file. Obviously that isn't necessary, but as soon as I generated all code for clients using the same T4 templates, I thought that it is more maintainable to generate invocations as well. I mentioned it before, but all code is available on GitHub, so you may have a look at ",t.createElement(a.a,{href:"https://github.com/AxelUser/examples/blob/master/DotNet/DictionaryOfTypes/Clients/StubbedClients.cs"},"generated clients")," and generated ",t.createElement(a.a,{href:"https://github.com/AxelUser/examples/blob/master/DotNet/DictionaryOfTypes/Benchmarking/BenchmarkCallsCreator.cs"},"provider invocations"),"."),"\n",t.createElement(a.p,null,"One more thing to know - because I don't want to include the creation of delegates with provider invocations, it's vital to move it into set-up, similar to the one that testing frameworks offer. BenchmarkDotNet has the same API for it, which means making set-up method and marking it with ",t.createElement(a.a,{href:"https://benchmarkdotnet.org/articles/features/setup-and-cleanup.html"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">GlobalSetup</code>'}}))," attribute:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">GlobalSetup</span></span><span class="token punctuation">]</span>\n<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    _simpleFactoryRunActions <span class="token operator">=</span> BenchmarkCallsCreator<span class="token punctuation">.</span><span class="token function">CreateInvocations</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SimpleClientFactoryProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Now all deletes are accessible from private field and its initialization won't affect the results."),"\n",t.createElement(a.p,null,"Anyway, let's run our benchmark and see how things are doing:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">|                         Method | Accesses |           Mean |         Error |        StdDev | Ratio |      Gen 0 | Gen 1 | Gen 2 | Allocated |\n|------------------------------- |--------- |---------------:|--------------:|--------------:|------:|-----------:|------:|------:|----------:|\n| SimpleFactory_SequentialAccess |      100 |       3.636 us |     0.0297 us |     0.0278 us |  1.00 |     0.3815 |     - |     - |   2.34 KB |\n|                                |          |                |               |               |       |            |       |       |           |\n| SimpleFactory_SequentialAccess |     1000 |      38.098 us |     0.2838 us |     0.2654 us |  1.00 |     3.7842 |     - |     - |  23.44 KB |\n|                                |          |                |               |               |       |            |       |       |           |\n| SimpleFactory_SequentialAccess | 10000000 | 383,617.687 us | 3,106.0346 us | 2,905.3867 us |  1.00 | 38000.0000 |     - |     - | 234375 KB |</code></pre></div>'}}),"\n",t.createElement(a.p,null,"We may see, that the provider performed quite fast (for now), but had allocated factory objects for each invocation of the factory provider. As I've said, for this issue there's a solution - ",t.createElement(a.strong,null,"caching factories"),"."),"\n",t.createElement(a.h2,{id:"store-factories-into-dictionary",style:{position:"relative"}},t.createElement(a.a,{href:"#store-factories-into-dictionary","aria-label":"store factories into dictionary permalink",className:"anchor before"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Store factories into Dictionary"),"\n",t.createElement(a.p,null,"The most obvious way to cache concrete factories is to store mapping from interface to factory, not just the mapping between interfaces and their implementation."),"\n",t.createElement(a.p,null,"Seems legit! So let's rewrite our initial factory method into one, which returns concrete client's factories for interfaces."),"\n",t.createElement(a.p,null,"Mapping reflection-based mechanism also should be rewritten to store concrete client factories for each interface into static dictionary object. As mentioned above, this mapping can performed once at application start-up, because factories are quite stateless by themselves."),"\n",t.createElement(a.p,null,"Unfortunately, we can't provide open generic type as the type for a value of our dictionary, but because all these factories are reference types, we can cast them to objects, put these values into the dictionary and when requested, receive from the dictionary and cast to a requested generic type. To make further examples simpler, I've extracted mapping construction into static helper ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ClientTypesProvider.GetAllTypes(Assembly)</code>'}}),", because it won't be changed further in the article."),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CachedSimpleFactoryProvider</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IClientsFactoryProvider</span></span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Type</span> FactoryType <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ClientFactory<span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>Type<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">></span></span> CachedClientFactories<span class="token punctuation">;</span>\n\n    <span class="token keyword">static</span> <span class="token function">CachedSimpleFactoryProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        CachedClientFactories <span class="token operator">=</span> ClientTypesProvider<span class="token punctuation">.</span><span class="token function">GetAllTypes</span><span class="token punctuation">(</span>Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">ToDictionary</span><span class="token punctuation">(</span>tuple <span class="token operator">=></span> tuple<span class="token punctuation">.</span>@<span class="token keyword">interface</span><span class="token punctuation">,</span> tuple <span class="token operator">=></span> <span class="token function">CreateFactory</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span>implementation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token return-type class-name">IClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">GetClientFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>CachedClientFactories<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> factory<span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Client type \'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">\' isn\'t supported"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>IClientFactory<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span> factory<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">CreateFactory</span><span class="token punctuation">(</span><span class="token class-name">Type</span> clientType<span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token class-name"><span class="token keyword">var</span></span> factory <span class="token operator">=</span> FactoryType<span class="token punctuation">.</span><span class="token function">MakeGenericType</span><span class="token punctuation">(</span>clientType<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> clientType<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Well, this solution isn't so elegant, but ",t.createElement(a.strong,null,"casting is mostly used to overcome the type system's limitation"),"."),"\n",t.createElement(a.p,null,"Now it's obvious that we've reduced memory consumption using pre-allocated factories, but what about speed?"),"\n",t.createElement(a.p,null,"Let's check the performance of this caching mechanism by writing a benchmark and compare results with the baseline:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">|                         Method | Accesses |           Mean |         Error |        StdDev | Ratio | RatioSD |      Gen 0 | Gen 1 | Gen 2 |   Allocated |\n|------------------------------- |--------- |---------------:|--------------:|--------------:|------:|--------:|-----------:|------:|------:|------------:|\n| SimpleFactory_SequentialAccess |      100 |       3.636 us |     0.0152 us |     0.0142 us |  1.00 |    0.00 |     0.3815 |     - |     - |      2400 B |\n| CachedFactory_SequentialAccess |      100 |       7.692 us |     0.0543 us |     0.0481 us |  2.12 |    0.01 |          - |     - |     - |           - |\n|                                |          |                |               |               |       |         |            |       |       |             |\n| SimpleFactory_SequentialAccess |     1000 |      35.619 us |     0.0787 us |     0.0697 us |  1.00 |    0.00 |     3.7842 |     - |     - |     24001 B |\n| CachedFactory_SequentialAccess |     1000 |      74.106 us |     0.9672 us |     0.9047 us |  2.08 |    0.03 |          - |     - |     - |         1 B |\n|                                |          |                |               |               |       |         |            |       |       |             |\n| SimpleFactory_SequentialAccess | 10000000 | 365,822.213 us | 2,226.8696 us | 2,083.0152 us |  1.00 |    0.00 | 38000.0000 |     - |     - | 240000000 B |\n| CachedFactory_SequentialAccess | 10000000 | 746,398.580 us | 3,361.2568 us | 3,144.1217 us |  2.04 |    0.02 |          - |     - |     - |           - |</code></pre></div>'}}),"\n",t.createElement(a.p,null,"Hm, seems like it's ",t.createElement(a.strong,null,"became SLOWER, than the original simple solution"),", but we may guess what operation caused such performance penalty. ",t.createElement(a.em,null,"Did we write something wrong or inefficient?")),"\n",t.createElement(a.p,null,'Earlier I\'ve mentioned that "dumb" casting from object to generic factory type. ',t.createElement(a.strong,null,"This simple cast is overkill for current situation")," - it involves type checking, but we know exactly what generic type stored under each key in dictionary."),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name">IClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">GetClientFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>CachedClientFactories<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> factory<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Client type \'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">\' isn\'t supported"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> Unsafe<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Once again check the benchmark results:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">|                         Method | Accesses |           Mean |         Error |        StdDev | Ratio |      Gen 0 | Gen 1 | Gen 2 |   Allocated |\n|------------------------------- |--------- |---------------:|--------------:|--------------:|------:|-----------:|------:|------:|------------:|\n| SimpleFactory_SequentialAccess |      100 |       3.492 us |     0.0143 us |     0.0134 us |  1.00 |     0.3815 |     - |     - |      2400 B |\n| CachedFactory_SequentialAccess |      100 |       3.138 us |     0.0022 us |     0.0020 us |  0.90 |          - |     - |     - |           - |\n|                                |          |                |               |               |       |            |       |       |             |\n| SimpleFactory_SequentialAccess |     1000 |      34.968 us |     0.3702 us |     0.3462 us |  1.00 |     3.7842 |     - |     - |     24000 B |\n| CachedFactory_SequentialAccess |     1000 |      31.494 us |     0.0589 us |     0.0522 us |  0.90 |          - |     - |     - |           - |\n|                                |          |                |               |               |       |            |       |       |             |\n| SimpleFactory_SequentialAccess | 10000000 | 369,860.373 us | 2,062.8473 us | 1,929.5887 us |  1.00 | 38000.0000 |     - |     - | 240000000 B |\n| CachedFactory_SequentialAccess | 10000000 | 306,086.300 us | 2,633.7588 us | 2,463.6196 us |  0.83 |          - |     - |     - |           - |</code></pre></div>'}}),"\n",t.createElement(a.p,null,"Much better - the speed of invocation is a little bit less than the baseline and the memory consumption is minimal."),"\n",t.createElement(a.p,null,"We may stay with this implementation, but if that was an option, I've never wrote such an obvious post ."),"\n",t.createElement(a.p,null,"So, is there a way to improve speed even more? Well, ",t.createElement(a.strong,null,"that's when generics steal the show!")),"\n",t.createElement(a.h2,{id:"delegate-caching-to-jit",style:{position:"relative"}},t.createElement(a.a,{href:"#delegate-caching-to-jit","aria-label":"delegate caching to jit permalink",className:"anchor before"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Delegate caching to JIT"),"\n",t.createElement(a.p,null,"This trick is mostly inspired by the way how ",t.createElement(a.a,{href:"https://docs.microsoft.com/en-us/dotnet/api/system.array.empty?view=netcore-3.1"},"Array.Empty")," works."),"\n",t.createElement(a.p,null,"Empty arrays are best candidates for caching, because their construction doesn't require any parameters, but only a generic type parameter."),"\n",t.createElement(a.p,null,"When you invoke ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Array.Empty&lt;MyClass></code>'}}),", it internally invokes a static read-only field ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Empty</code>'}})," of static generic class ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">EmptyArray&lt;MyClass></code>'}}),", which initializes and returns an empty array of type ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">MyClass</code>'}})," (have a look at ",t.createElement(a.a,{href:"https://github.com/dotnet/runtime/blob/3705185af806e273ccef98e44699400f0416c452/src/libraries/System.Private.CoreLib/src/System/Array.cs#L694-L704"},"sources"),"). Static field is initialized during the time of a first access to the field of the class ",t.createElement(a.em,null,"EmptyArray"),". This is guaranteed from the fact how generics and static classes work in ",t.createElement(a.strong,null,"CLR")," (Common Language Runtime). For your information, that's how you can implement a ",t.createElement(a.a,{href:"https://csharpindepth.com/articles/singleton"},"simple thread-safe singleton")," in .Net."),"\n",t.createElement(a.h2,{id:"how-clr-compiles-generic-classes",style:{position:"relative"}},t.createElement(a.a,{href:"#how-clr-compiles-generic-classes","aria-label":"how clr compiles generic classes permalink",className:"anchor before"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"How CLR compiles generic classes"),"\n",t.createElement(a.p,null,"Generics are types, that contain a type parameter, which isn't known at compile time (e.g. ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">List&lt;T></code>'}}),"). When dotnet compiler sees open generic type, it compiles it into IL with the same generic type parameter."),"\n",t.createElement(a.p,null,"After the type argument is passed into generic constructor (e.g. ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">List&lt;MyClass></code>'}}),"), CLR will do the following:"),"\n",t.createElement(a.ol,null,"\n",t.createElement(a.li,null,"Lookup if the closed generic (with concrete generic type argument) was requested before."),"\n",t.createElement(a.li,null,"If not - it will be compiled at run time."),"\n"),"\n",t.createElement(a.p,null,"Nice point is that JIT compiler will share all code for specific generics, which have only reference types as their type parameters. This optimization makes sense, because objects of reference types are passed into methods by fixed-sized reference to their content in the managed heap. All references to objects have common size, which equals to the machine word: 32 or 64 bits, depending on the architecture of an operating system and processor."),"\n",t.createElement(a.p,null,"It doesn't mean, that compiler vanishes all information about different closed generics, but instead of compiling the whole code for the class, it will save the information about concrete closed generic into ",t.createElement(a.strong,null,"Method Table"),"."),"\n",t.createElement(a.p,null,"It worth mentioning, that for value types, like structs and primitives, JIT will compile specialized code to handle each type parameters combination, which were passed during the construction of a closed generic."),"\n",t.createElement(a.p,null,"Using the knowledge about how generics are compiled and how static fields are initialized, we can implement a cache for factory producer."),"\n",t.createElement(a.h2,{id:"implementing-a-generic-based-cached-producer",style:{position:"relative"}},t.createElement(a.a,{href:"#implementing-a-generic-based-cached-producer","aria-label":"implementing a generic based cached producer permalink",className:"anchor before"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Implementing a generic-based cached producer"),"\n",t.createElement(a.p,null,"Let's create a new static class ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">CachedFactory&lt;T></code>'}})," with static field ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Instance</code>'}}),", which is initialized with a factory for the concrete client implementing interface ",t.createElement(a.em,null,"T"),". The factory creation is extracted into the method, that gets implementation type from static dictionary and creates a factory."),"\n",t.createElement(a.p,null,"How new static factories can access the mapping information? One way is to make that dictionary public, as well as making this new class as public. However, as I mentioned before in the case of dictionary-based caching solution, that will pollute a namespace with things you should never access manually."),"\n",t.createElement(a.p,null,"Encapsulation of the caching mechanism can be achieved by making the class ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">CachedFactory&lt;T></code>'}})," private and nesting it inside the actual provider class. In that case the public factory provider will have full access the public field of ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">CachedFactory&lt;T></code>'}}),", without opening its API to the outer code"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">GenericClientFactoryProvider</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">CachedFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">IClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">?</span></span> Instance<span class="token punctuation">;</span>\n\n        <span class="token keyword">static</span> <span class="token function">CachedFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token punctuation">{</span>\n            Instance <span class="token operator">=</span> <span class="token function">CreateFactoryIfAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">IClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">?</span></span> <span class="token function">CreateFactoryIfAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n            DiscoveredAllowedClientTypes<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> implType<span class="token punctuation">)</span>\n                <span class="token punctuation">?</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span>implType<span class="token punctuation">)</span>\n                <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"However, there is also a caveat - ",t.createElement(a.strong,null,"when a type ",t.createElement(a.em,null,"T")," isn't stored in dictionary, the generic nevertheless will be compiled and stored at Method Table until the end of execution"),". That's why the whole generics trick may be a bad idea, if the client interface is passed from user input."),"\n",t.createElement(a.p,null,"To make things a little bit fancier, ",t.createElement(a.strong,null,"code with nested class may be extracted into own file"),", if the factory provider will be marked as partial. It's up to you how to name that file, but I recommend you to write the name of the provider plus the name of cached factory, separated by the dot, like ",t.createElement(a.em,null,"GenericClientFactoryProvider.CachedFactory.cs"),"."),"\n",t.createElement(a.p,null,"Provider will trigger client creation when accessing the field ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Instance</code>'}})," of a closed generic ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">CachedFactory&lt;T></code>'}})," class for the first time:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">GenericClientFactoryProvider</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IClientsFactoryProvider</span></span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>Type<span class="token punctuation">,</span> Type<span class="token punctuation">></span></span> DiscoveredAllowedClientTypes<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token return-type class-name">IClientFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">GetClientFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> CachedFactory<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">.</span>Instance <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Client type \'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">\' isn\'t supported"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">static</span> <span class="token function">GenericClientFactoryProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        DiscoveredAllowedClientTypes <span class="token operator">=</span> ClientTypesProvider<span class="token punctuation">.</span><span class="token function">GetAllTypes</span><span class="token punctuation">(</span>Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">ToDictionary</span><span class="token punctuation">(</span>tuple <span class="token operator">=></span> tuple<span class="token punctuation">.</span>@<span class="token keyword">interface</span><span class="token punctuation">,</span> tuple <span class="token operator">=></span> tuple<span class="token punctuation">.</span>implementation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"If client creation shouldn't be lazy, fields for all closed generic classes can be accessed at the same time, when mapping is created."),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">static</span> <span class="token function">GenericClientFactoryProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    DiscoveredAllowedClientTypes <span class="token operator">=</span> ClientTypesProvider<span class="token punctuation">.</span><span class="token function">GetAllTypes</span><span class="token punctuation">(</span>Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">ToDictionary</span><span class="token punctuation">(</span>tuple <span class="token operator">=></span> tuple<span class="token punctuation">.</span>@<span class="token keyword">interface</span><span class="token punctuation">,</span> tuple <span class="token operator">=></span> tuple<span class="token punctuation">.</span>implementation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token function">InitializeFactories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Eager initialization</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">InitializeFactories</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token class-name"><span class="token keyword">var</span></span> factory <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">CachedFactory<span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> @<span class="token keyword">interface</span> <span class="token class-name"><span class="token keyword">in</span></span> DiscoveredAllowedClientTypes<span class="token punctuation">.</span>Keys<span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token class-name"><span class="token keyword">var</span></span> genericFactory <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">MakeGenericType</span><span class="token punctuation">(</span>@<span class="token keyword">interface</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name"><span class="token keyword">var</span></span> instanceProperty <span class="token operator">=</span> genericFactory<span class="token punctuation">.</span><span class="token function">GetField</span><span class="token punctuation">(</span><span class="token string">"Instance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        instanceProperty<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"Now let's add a new benchmark and check the performance:"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">|                                  Method | Accesses |           Mean |         Error |        StdDev | Ratio |      Gen 0 | Gen 1 | Gen 2 |   Allocated |\n|---------------------------------------- |--------- |---------------:|--------------:|--------------:|------:|-----------:|------:|------:|------------:|\n|          SimpleFactory_SequentialAccess |      100 |       3.538 us |     0.0454 us |     0.0402 us |  1.00 |     0.3815 |     - |     - |      2400 B |\n|          CachedFactory_SequentialAccess |      100 |       3.213 us |     0.0233 us |     0.0218 us |  0.91 |          - |     - |     - |           - |\n| CompiledGenericFactory_SequentialAccess |      100 |       1.390 us |     0.0128 us |     0.0107 us |  0.39 |          - |     - |     - |           - |\n|                                         |          |                |               |               |       |            |       |       |             |\n|          SimpleFactory_SequentialAccess |     1000 |      36.258 us |     0.1383 us |     0.1294 us |  1.00 |     3.7842 |     - |     - |     24000 B |\n|          CachedFactory_SequentialAccess |     1000 |      31.292 us |     0.1065 us |     0.0890 us |  0.86 |          - |     - |     - |           - |\n| CompiledGenericFactory_SequentialAccess |     1000 |      14.505 us |     0.0144 us |     0.0120 us |  0.40 |          - |     - |     - |           - |\n|                                         |          |                |               |               |       |            |       |       |             |\n|          SimpleFactory_SequentialAccess | 10000000 | 374,137.631 us | 1,675.7705 us | 1,399.3442 us |  1.00 | 38000.0000 |     - |     - | 240000000 B |\n|          CachedFactory_SequentialAccess | 10000000 | 307,281.414 us | 1,939.4985 us | 1,719.3149 us |  0.82 |          - |     - |     - |           - |\n| CompiledGenericFactory_SequentialAccess | 10000000 | 144,997.830 us |   715.7528 us |   634.4962 us |  0.39 |          - |     - |     - |       334 B |</code></pre></div>'}}),"\n",t.createElement(a.p,null,"Speed of invocation has been dramatically increased, compared to the previous dictionary-based solution. Now we may use this solution with interface defined earlier, gaining all benefits of generic type lookup, which give us the runtime itself."),"\n",t.createElement(a.h2,{id:"conclusion",style:{position:"relative"}},t.createElement(a.a,{href:"#conclusion","aria-label":"conclusion permalink",className:"anchor before"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Conclusion"),"\n",t.createElement(a.p,null,"All these solutions are powered by the knowledge of runtime internals, which may increase the difficulty of understanding how much benefits we receive. ",t.createElement(a.strong,null,"When messing with such hacks don't hesitate to check the performance incrementally via benchmarking"),". I hope that my examples proves you, that this process isn't much harder than writing a unit-tests, thanks to BenchmarkDotNet!"),"\n",t.createElement(a.p,null,"All provided solutions are quite specialized for the task of caching values, which don't depend on dynamic parameters. In other words all values can be initialized during the application start-up. If that is your case, you may use provided solutions and I hope you will improve the overall performance of your program."),"\n",t.createElement(a.h2,{id:"references",style:{position:"relative"}},t.createElement(a.a,{href:"#references","aria-label":"references permalink",className:"anchor before"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"References"),"\n",t.createElement(a.ol,null,"\n",t.createElement(a.li,null,t.createElement(a.a,{href:"https://codeblog.jonskeet.uk/2017/04/26/surprise-creating-an-instance-of-an-open-generic-type/"},"How to create open generic type at runtime")),"\n",t.createElement(a.li,null,t.createElement(a.a,{href:"https://alexandrnikitin.github.io/blog/dotnet-generics-under-the-hood/"},"Generic types under the hood")),"\n",t.createElement(a.li,null,t.createElement(a.a,{href:"https://benchmarkdotnet.org/"},"BenchmarkDotNet website")),"\n"))}var c=function(n){void 0===n&&(n={});const{wrapper:a}=Object.assign({},(0,s.ah)(),n.components);return a?t.createElement(a,n,t.createElement(o,n)):o(n)},p=e(5785),l=e(3147),i=e(6864),r=e(4001),u=e(778),k=e(6753);const m=n=>{let{data:{current:a,next:e,previous:s},children:o}=n;return t.createElement(l.Z,{displayBio:l.x.AfterContent},t.createElement("div",{className:k.nC},t.createElement("span",{className:k.$y},t.createElement("time",null,a.frontmatter.date),t.createElement(u.Z,{tags:(0,p.Z)(a.frontmatter.tags)})),t.createElement("h1",null,null==a?void 0:a.frontmatter.title),t.createElement("div",{className:k.fL},o),t.createElement(i.Z,{prev:null!=s?{link:s.fields.path,title:s.frontmatter.title}:void 0,next:null!=e?{link:e.fields.path,title:e.frontmatter.title}:void 0})))},d=n=>{let{data:a}=n;return t.createElement(r.p,{title:a.current.frontmatter.title})};function h(n){return t.createElement(m,n,t.createElement(c,n))}},3147:function(n,a,e){e.d(a,{x:function(){return i},Z:function(){return r}});var s=e(1883),t=e(7294);e(358);var o=()=>t.createElement("div",{className:"y0ya850"},t.createElement("p",null,"Hi, I'm ",t.createElement("b",null,"Aleksey"),"!"),t.createElement("p",null,"I'm a ",t.createElement("span",{className:"y0ya851"},"Senior Software Engineer")," ","with a focus on distributed and high-load systems. I work with ",t.createElement("b",null,"#"),","," ",t.createElement("b",null,"Go")," and ",t.createElement("b",null,"Kotlin"),". Check out my"," ",t.createElement("a",{href:"https://www.linkedin.com/in/dev-alexey-maltsev/"},"LinkedIn")," for my latest experience and my"," ",t.createElement("a",{href:"https://github.com/AxelUser"},"GitHub")," for projects.")),c="_15u9v4n2";const p=()=>t.createElement("header",null,t.createElement("nav",{className:"_15u9v4n1"},t.createElement(s.Link,{className:c,to:"/"},"Blog"),t.createElement(s.Link,{className:c,to:"/art"},"Art"))),l=n=>{let{author:a,currentYear:e}=n;return t.createElement("footer",null,t.createElement("small",null," ",e," ",a))};let i=function(n){return n[n.BeforeContent=0]="BeforeContent",n[n.AfterContent=1]="AfterContent",n}({});var r=n=>{var a,e,c,r;let{displayBio:u,children:k}=n;const m=(0,s.useStaticQuery)("4125657994");return t.createElement("div",{className:"_15u9v4n0"},t.createElement(p,null),u==i.BeforeContent&&t.createElement(o,null),k,u==i.AfterContent&&t.createElement(o,null),t.createElement(l,{author:(null==m||null===(a=m.site)||void 0===a||null===(e=a.siteMetadata)||void 0===e?void 0:e.author)||"",currentYear:(null==m||null===(c=m.site)||void 0===c||null===(r=c.siteMetadata)||void 0===r?void 0:r.currentYear)||0}))}},6864:function(n,a,e){e.d(a,{Z:function(){return c}});var s=e(1883),t=e(7294);e(358);const o=n=>{let{prefix:a,to:e}=n;return e?t.createElement(s.Link,{to:e.link,className:"u67xr02"},t.createElement("span",{className:"u67xr03"},a),t.createElement("span",{className:"u67xr04"},e.title)):t.createElement(t.Fragment,null)};var c=n=>{let{prev:a,next:e}=n;return t.createElement("nav",{className:"u67xr01"},t.createElement(o,{prefix:"Previous",to:a}),t.createElement(o,{prefix:"Next",to:e}))}},4001:function(n,a,e){e.d(a,{p:function(){return o}});var s=e(1883),t=e(7294);function o(n){var a,e,o,c,p,l;const i=(0,s.useStaticQuery)("834308132"),r=n.title?(null==i||null===(a=i.site)||void 0===a||null===(e=a.siteMetadata)||void 0===e?void 0:e.title)+" | "+n.title:null==i||null===(o=i.site)||void 0===o||null===(c=o.siteMetadata)||void 0===c?void 0:c.title;return t.createElement(t.Fragment,null,t.createElement("title",null,r),t.createElement("meta",{name:"google-site-verification",content:(null==i||null===(p=i.site)||void 0===p||null===(l=p.siteMetadata)||void 0===l?void 0:l.googleSiteVerification)||void 0}))}},778:function(n,a,e){var s=e(7294);a.Z=n=>{let{tags:a}=n;return s.createElement(s.Fragment,null,a.map((n=>s.createElement("span",null,"[",n,"]"))))}},1151:function(n,a,e){e.d(a,{ah:function(){return o}});var s=e(7294);const t=s.createContext({});function o(n){const a=s.useContext(t);return s.useMemo((()=>"function"==typeof n?n(a):{...a,...n}),[a,n])}}}]);
//# sourceMappingURL=component---src-templates-blog-post-tsx-content-file-path-content-blog-005-dictionary-on-generics-index-md-fb6f10bca21d4e8f45c6.js.map