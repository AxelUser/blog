<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.7 'JetBrains Mono',monospace;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'JetBrains Mono',monospace;font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}h1{margin-left:0;margin-right:0;margin-top:2.55rem;padding-bottom:calc(0.425rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.275rem;color:inherit;font-family:'JetBrains Mono',monospace;font-weight:bold;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:1.7rem;padding-bottom:calc(0.425rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.425rem;color:inherit;font-family:'JetBrains Mono',monospace;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;color:inherit;font-family:'JetBrains Mono',monospace;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;color:inherit;font-family:'JetBrains Mono',monospace;font-weight:bold;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;color:inherit;font-family:'JetBrains Mono',monospace;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;color:inherit;font-family:'JetBrains Mono',monospace;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}ul{margin-left:1.7rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.7rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}p{margin-left:0;margin-right:0;margin-top:1.7rem;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;font-size:0.85rem;line-height:1.7rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;font-size:1rem;line-height:1.7rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}blockquote{margin-left:1.7rem;margin-right:1.7rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.7rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.7rem;}b{font-weight:bold;}strong{font-weight:bold;}dt{font-weight:bold;}th{font-weight:bold;}li{margin-bottom:calc(1.7rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.7rem;margin-bottom:calc(1.7rem / 2);margin-top:calc(1.7rem / 2);}li > ul{margin-left:1.7rem;margin-bottom:calc(1.7rem / 2);margin-top:calc(1.7rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.7rem / 2);}code{font-size:0.85rem;line-height:1.7rem;}kbd{font-size:0.85rem;line-height:1.7rem;}samp{font-size:0.85rem;line-height:1.7rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.13333rem;padding-right:1.13333rem;padding-top:0.85rem;padding-bottom:calc(0.85rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h3,h4,h5,h6{margin-bottom:0.85rem;margin-top:1.7rem;}ol,ul{margin-left:2.125rem;}li>ol,li>ul{margin-left:2.125rem;}</style><meta name="generator" content="Gatsby 5.10.0"/><meta name="google-site-verification" content="8Dy4lxRZAH8BAi86GsiP9mlM_ELJLCh839CXT3W32SI" data-gatsby-head="true"/><style data-href="/styles.f6ae14514d980cf9f037.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#ccc;font-family:JetBrains Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2e2e2e}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}:root{--_1rkee8i0:#2e2e2e;--_1rkee8i1:#f8f8ff;--_1rkee8i2:#737373;--_1rkee8i3:#e6a627;--_1rkee8i4:#e6a627;--_1rkee8i5:#737373;--_1rkee8i6:1.1rem;--_1rkee8i7:1.1rem}*{margin:0}body{background-color:var(--_1rkee8i0);color:var(--_1rkee8i1);min-height:100vh}a{text-decoration:none}a,a:hover{color:inherit}._1alt5bj0{overflow:hidden}._1f1szv30{border-bottom:1px dotted var(--_1rkee8i5);min-height:11.1rem;padding-bottom:.28rem;padding-left:var(--_1rkee8i6);padding-right:var(--_1rkee8i7);padding-top:2rem}._1f1szv30:hover{background-color:var(--_1rkee8i1);color:var(--_1rkee8i0)}._1f1szv31{color:var(--_1rkee8i2);display:flex;gap:1.6rem}._1f1szv32{max-width:400px;position:absolute;z-index:-1}._1f1szv34{margin-bottom:0;margin-top:1rem}._1f1szv35{margin-bottom:1rem;margin-top:1rem}._12v82x60{columns:12rem;display:block;gap:1rem}._12v82x61{break-inside:avoid;margin-bottom:1rem}._12v82x61:hover{cursor:pointer}._11ku9v70{background-color:#000000f2;display:flex;flex-direction:row;height:100%;justify-content:center;left:0;overflow:auto;position:fixed;top:0;width:100%;z-index:1}._11ku9v71{color:#fff;font-size:35px;font-weight:700;position:fixed;right:25px;top:10px}._11ku9v71:hover{cursor:pointer}._11ku9v73{--_11ku9v72:5rem;display:flex;flex-direction:row;width:100vw}._11ku9v74{cursor:pointer;font-size:35px;font-weight:700;-webkit-user-select:none;user-select:none}._11ku9v75{margin:auto 0 auto var(--_11ku9v72)}._11ku9v76{margin:auto var(--_11ku9v72) auto 0}._11ku9v77{margin:auto;max-height:80vh;max-width:80vw}@media (pointer:coarse){._11ku9v74{display:none}}.y0ya850{border-color:var(--_1rkee8i5);border-radius:10px;border-style:solid;border-width:1px;margin-bottom:1rem;padding:1rem}.y0ya851{color:var(--_1rkee8i1);text-shadow:0 0 10px var(--_1rkee8i3)}.y0ya850 a{color:var(--_1rkee8i3)}.y0ya850 a:hover{border-bottom:1px solid var(--_1rkee8i3)}.y0ya850 p{margin-bottom:.75rem;margin-top:.75rem}.y0ya850 p:first-child{margin-top:0}.y0ya850 p:last-child{margin-bottom:0}._15u9v4n0{display:flex;flex-direction:column;margin:auto;max-width:700px;min-height:100vh}._15u9v4n1{display:flex;font-weight:700;gap:1.5rem;padding:1.45rem var(--_1rkee8i7) 1rem var(--_1rkee8i6)}._15u9v4n2{color:var(--_1rkee8i1);font-size:1.05rem;padding-bottom:.3rem}._15u9v4n2:after{background:var(--_1rkee8i1);content:"";display:block;height:2px;opacity:0;pointer-events:none;transition:all .2s;width:100%}._15u9v4n2:hover:after{opacity:1}._15u9v4n0 footer{margin-top:auto}._15u9v4n0 footer small{margin-bottom:1.3rem;margin-top:2rem}._15u9v4n0 footer small,.mjeqyr0{display:flex;justify-content:center}.mjeqyr0{align-items:center;flex-direction:column;margin:auto}.mjeqyr1{border-bottom:1px solid transparent;color:var(--_1rkee8i3);margin-top:3rem}.mjeqyr1:hover{border-bottom-color:var(--_1rkee8i3);color:var(--_1rkee8i3)}._6x0bhr0,.z8eld70{padding-left:var(--_1rkee8i6);padding-right:var(--_1rkee8i7)}.u67xr01{--u67xr00:var(--_1rkee8i1);display:flex;gap:1.5rem;margin-top:2rem}.u67xr02{border:1px solid var(--_1rkee8i5);border-radius:8px;display:flex;flex-direction:column;padding:.5rem}.u67xr02:hover{--u67xr00:var(--_1rkee8i3);cursor:pointer}.u67xr03{color:var(--_1rkee8i2);font-size:12px;font-weight:700}.u67xr04,.u67xr04:hover{color:var(--u67xr00)}.u67xr01 :nth-child(2){align-items:flex-end;margin-left:auto}@media (max-width:650px){.u67xr01{flex-direction:column}.u67xr01 :nth-child(2){align-items:flex-start;margin-left:0}}@media (min-width:650px){.u67xr02{max-width:300px}}._14sfvu70{padding:.5rem var(--_1rkee8i7) 2rem var(--_1rkee8i6)}._14sfvu70>h1{color:var(--_1rkee8i4);margin-top:1.5rem}._14sfvu71{border-bottom:1px dotted var(--_1rkee8i5)}._14sfvu71 a{color:var(--_1rkee8i3)}._14sfvu71 a:hover{border-bottom:1px solid var(--_1rkee8i3)}a.anchor{fill:var(--_1rkee8i1);padding-right:7px}a.anchor:hover{border-bottom:none}._14sfvu72{color:var(--_1rkee8i2);display:flex;font-size:1rem;gap:1.5rem}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=f63c31d361d8ba82a0deaf357d918136" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=f63c31d361d8ba82a0deaf357d918136"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=f63c31d361d8ba82a0deaf357d918136"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=f63c31d361d8ba82a0deaf357d918136"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=f63c31d361d8ba82a0deaf357d918136"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=f63c31d361d8ba82a0deaf357d918136"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=f63c31d361d8ba82a0deaf357d918136"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=f63c31d361d8ba82a0deaf357d918136"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=f63c31d361d8ba82a0deaf357d918136"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link href="//fonts.googleapis.com/css?family=JetBrains+Mono:300" rel="stylesheet" type="text/css"/><title data-gatsby-head="true">Maltsev Space | Checking MongoDB Operation Status: A Simple Guide</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="_15u9v4n0"><header><nav class="_15u9v4n1"><a class="_15u9v4n2" href="/">Blog</a><a class="_15u9v4n2" href="/art/">Art</a></nav></header><div class="_14sfvu70"><span class="_14sfvu72"><time>20 Apr, 2022</time><span>[<!-- -->MongoDB<!-- -->]</span></span><h1>Checking MongoDB Operation Status: A Simple Guide</h1><div class="_14sfvu71"><p>When working with databases, it&#x27;s not uncommon to inspect the status of a running query, whether it&#x27;s for profiling purposes or as part of a polling mechanism for asynchronous operations. In this blog post, we&#x27;ll explore how to use MongoDB&#x27;s $currentOp stage to retrieve information about running queries and how to use this functionality to store the status of running operations.</p>
<h2 id="background" style="position:relative"><a href="#background" aria-label="background permalink" class="anchor before"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Background</h2>
<p>My use case involves building a background service that handles data retention. The service should be able to handle multiple requests and be tolerant to failures during deletion handling. To achieve this, I need to store the states of running operations so that they can be checked during failure recovery or regular reboot/deployment.</p>
<p>To receive requests, I&#x27;ll use a message broker like Kafka. The service will receive messages with a <span><code class="language-text">JobId</code></span> and a condition specifying which data to delete. After the deletion is completed, the service will commit the message. If the service is restarted or fails, it will receive the uncommitted message again.</p>
<h2 id="solution" style="position:relative"><a href="#solution" aria-label="solution permalink" class="anchor before"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Solution</h2>
<p>A straightforward solution is to store the state in another MongoDB collection. However, storing the state may be redundant since the only need for that state is to tell if the operation was completed, and if not, whether it is running or failed.</p>
<p>Most of the databases I&#x27;ve worked with have special tables or views with information about all running queries, and MongoDB is no exception. It has a special query called <a href="https://www.mongodb.com/docs/manual/reference/method/db.currentOp/">db.currentOp()</a> that returns a document with information about all running queries.</p>
<p>However, this API has limitations caused by MongoDB specifics. So, there&#x27;s a more modern way of retrieving running queries: the <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/currentOp/">$currentOp</a> stage for the aggregation pipeline. It works like a regular stage and can be combined with other aggregation features like projection and grouping. I&#x27;ll use this approach for my solution.</p>
<p>There are several things to keep in mind:</p>
<ol>
<li>
<p>The aggregation pipeline with this stage should be run on the <span><code class="language-text">admin</code></span> collection, and you need a special user to access it via your application.</p>
</li>
<li>
<p>This command returns operations that are started on a specific MongoDB node. If you&#x27;re using a sharded cluster like we are, you need to run <span><code class="language-text">$currentOp</code></span> on the router that started the specific delete operation. It&#x27;s not a big deal, though; you can run this query against all routers in parallel and check if any have it.</p>
</li>
<li>
<p>You need to distinguish delete operations started by your service from normal operations. In our case, all data retention tasks have a <span><code class="language-text">JobId</code></span>, which is a unique key for the operation. All we need is a way to mark MongoDB queries with this key.</p>
</li>
</ol>
<p>If we look through the output format for <span><code class="language-text">$currentOp</code></span>, we&#x27;ll notice that it has a <a href="https://www.mongodb.com/docs/manual/reference/command/currentOp/#mongodb-data-currentOp.command">comment</a> field that can be attached when a command is started. Some queries (e.g., <span><code class="language-text">find</code></span>) support the <a href="https://www.mongodb.com/docs/manual/reference/operator/query/comment/">$comment</a> operator, but the most universal way to pass a comment is to run a query via a <a href="https://www.mongodb.com/docs/manual/reference/command/#database-commands">database command</a>. With this API, we can run the delete command and pass the <span><code class="language-text">JobId</code></span> into the comment field.</p>
<h2 id="example" style="position:relative"><a href="#example" aria-label="example permalink" class="anchor before"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Example</h2>
<p>Now, let&#x27;s look at some MongoDB shell examples.</p>
<h3 id="starting-delete-operation-with-jobid" style="position:relative"><a href="#starting-delete-operation-with-jobid" aria-label="starting delete operation with jobid permalink" class="anchor before"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Starting delete operation with &quot;JobId&quot;</h3>
<p>To pass <span><code class="language-text">JobId</code></span> into the comment when we start the delete operation, we can use the following command:</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">delete</span><span class="token operator">:</span> <span class="token string">"Events"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">ordered</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">"job:blog-test"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">deletes</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">q</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">clientId</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div></span>
<p>This MongoDB query is designed to delete all documents from the <span><code class="language-text">"Events"</code></span> collection where the <span><code class="language-text">"clientId"</code></span> field equals <span><code class="language-text">0</code></span>. The query is executed using the <span><code class="language-text">runCommand</code></span> method, which takes a single argument that is a document representing the command to be executed.</p>
<p>The command document contains several fields:</p>
<ul>
<li>
<p><span><code class="language-text">"delete"</code></span>: This field specifies the name of the collection to delete documents from, which is <span><code class="language-text">"Events"</code></span> in this case.</p>
</li>
<li>
<p><span><code class="language-text">"ordered"</code></span>: This field specifies whether the deletion operation should be executed in order, with each deletion waiting for the previous one to complete before starting. In this case, it is set to false, indicating that the deletion operations can be executed in parallel.</p>
</li>
<li>
<p><span><code class="language-text">"comment"</code></span>: This field is an optional comment that can be included in the command. It has no effect on the operation itself, but will be highly useful in further command below.</p>
</li>
<li>
<p><span><code class="language-text">"deletes"</code></span>: This field contains an array of objects, each representing a deletion operation to be executed. In this case, there is only one object, which contains two fields:</p>
<ul>
<li>
<p><span><code class="language-text">"q"</code></span>: This field specifies the query that will be used to match documents to be deleted. In this case, the query is searching for documents where the <span><code class="language-text">"clientId"</code></span> field equals 0.</p>
</li>
<li>
<p><span><code class="language-text">"limit"</code></span>: This field specifies the maximum number of documents to delete. In this case, it is set to 0, indicating that all documents matching the query should be deleted.</p>
</li>
</ul>
</li>
</ul>
<p>When executed, this query will delete all documents from the <span><code class="language-text">"Events"</code></span> collection where the <span><code class="language-text">"clientId"</code></span> field equals <span><code class="language-text">0</code></span>. The deletion will be executed in parallel and there is no limit to the number of documents that can be deleted. The optional comment included in the command document is &quot;job:blog-test&quot;, which is our <span><code class="language-text">JobId</code></span>.</p>
<h3 id="finding-running-operation-by-jobid" style="position:relative"><a href="#finding-running-operation-by-jobid" aria-label="finding running operation by jobid permalink" class="anchor before"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Finding running operation by &quot;JobId&quot;</h3>
<p>MongoDB query below uses the aggregate method to find a specific operation that has a JobId in its command.comment field:</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">$currentOp</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">localOps</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">$match</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">"command.comment"</span><span class="token operator">:</span> <span class="token string">"job:blog-test"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">$limit</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div></span>
<p>The first stage of the pipeline is <span><code class="language-text">$currentOp</code></span>, which returns information about the current operations running on the server. The <span><code class="language-text">localOps</code></span> option is set to <span><code class="language-text">true</code></span>, which limits the output to only show operations running on the same node as the query.</p>
<p>The second stage is <span><code class="language-text">$match</code></span>, which filters the running operations based on a specific condition. In this case, it matches operations that have a comment field in their command object that matches the value &quot;job:blog-test&quot;.</p>
<p>The third stage is <span><code class="language-text">$limit</code></span>, which limits the output to the first document that matches the filter. Since we are looking for a single operation, we must set the limit to <span><code class="language-text">1</code></span>.</p>
<p>In summary, this query finds the first operation running on the current node that has a <span><code class="language-text">JobId</code></span> in its command.comment field equal to <span><code class="language-text">"job:blog-test"</code></span>.</p>
<p>If an operation with such a comment is running on the current node (or router), we&#x27;ll receive a single document, containing all the info about operation with specified <span><code class="language-text">JobId</code></span>:</p>
<span><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"op"</span><span class="token punctuation">,</span>
    <span class="token property">"host"</span> <span class="token operator">:</span> <span class="token string">"f0fde895fb50:27017"</span><span class="token punctuation">,</span>
    <span class="token property">"desc"</span> <span class="token operator">:</span> <span class="token string">"conn65"</span><span class="token punctuation">,</span>
    <span class="token property">"connectionId"</span> <span class="token operator">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
    <span class="token property">"client"</span> <span class="token operator">:</span> <span class="token string">"172.18.0.1:57176"</span><span class="token punctuation">,</span>
    <span class="token property">"appName"</span> <span class="token operator">:</span> <span class="token string">"MongoDB Shell"</span><span class="token punctuation">,</span>
    <span class="token property">"clientMetadata"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"application"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"MongoDB Shell"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"driver"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"MongoDB Internal Client"</span><span class="token punctuation">,</span>
            <span class="token property">"version"</span> <span class="token operator">:</span> <span class="token string">"4.2.6-18-g6cdb6ab"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"Windows"</span><span class="token punctuation">,</span>
            <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"Microsoft Windows 8"</span><span class="token punctuation">,</span>
            <span class="token property">"architecture"</span> <span class="token operator">:</span> <span class="token string">"x86_64"</span><span class="token punctuation">,</span>
            <span class="token property">"version"</span> <span class="token operator">:</span> <span class="token string">"6.2 (build 9200)"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"mongos"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"host"</span> <span class="token operator">:</span> <span class="token string">"f0fde895fb50:27017"</span><span class="token punctuation">,</span>
            <span class="token property">"client"</span> <span class="token operator">:</span> <span class="token string">"172.18.0.1:57176"</span><span class="token punctuation">,</span>
            <span class="token property">"version"</span> <span class="token operator">:</span> <span class="token string">"4.4.11"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"active"</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"currentOpTime"</span> <span class="token operator">:</span> <span class="token string">"2022-04-19T22:01:50.629+00:00"</span><span class="token punctuation">,</span>
    <span class="token property">"opid"</span> <span class="token operator">:</span> <span class="token number">996</span><span class="token punctuation">,</span>
    <span class="token property">"lsid"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"id"</span> <span class="token operator">:</span> UUID(<span class="token string">"e42b457e-bc01-4ffa-83dc-343f1f6ea351"</span>)<span class="token punctuation">,</span>
        <span class="token property">"uid"</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"$binary"</span> <span class="token operator">:</span> <span class="token string">"47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU="</span><span class="token punctuation">,</span> <span class="token property">"$type"</span> <span class="token operator">:</span> <span class="token string">"00"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"secs_running"</span> <span class="token operator">:</span> NumberLong(<span class="token number">3</span>)<span class="token punctuation">,</span>
    <span class="token property">"microsecs_running"</span> <span class="token operator">:</span> NumberLong(<span class="token number">3406911</span>)<span class="token punctuation">,</span>
    <span class="token property">"op"</span> <span class="token operator">:</span> <span class="token string">"remove"</span><span class="token punctuation">,</span>
    <span class="token property">"ns"</span> <span class="token operator">:</span> <span class="token string">"testdb.Events"</span><span class="token punctuation">,</span>
    <span class="token property">"command"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"delete"</span> <span class="token operator">:</span> <span class="token string">"Events"</span><span class="token punctuation">,</span>
        <span class="token property">"ordered"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">"comment"</span> <span class="token operator">:</span> <span class="token string">"job:blog-test"</span><span class="token punctuation">,</span>
        <span class="token property">"lsid"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"id"</span> <span class="token operator">:</span> UUID(<span class="token string">"e42b457e-bc01-4ffa-83dc-343f1f6ea351"</span>)
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"$clusterTime"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"clusterTime"</span> <span class="token operator">:</span> Timestamp(<span class="token number">1650405661</span><span class="token punctuation">,</span> <span class="token number">34</span>)<span class="token punctuation">,</span>
            <span class="token property">"signature"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"hash"</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"$binary"</span> <span class="token operator">:</span> <span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">,</span> <span class="token property">"$type"</span> <span class="token operator">:</span> <span class="token string">"00"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">"keyId"</span> <span class="token operator">:</span> NumberLong(<span class="token number">0</span>)
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"$readPreference"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"mode"</span> <span class="token operator">:</span> <span class="token string">"secondaryPreferred"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"$db"</span> <span class="token operator">:</span> <span class="token string">"testdb"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"numYields"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">"waitingForLatch"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"timestamp"</span> <span class="token operator">:</span> ISODate(<span class="token string">"2022-04-19T22:01:47.323Z"</span>)<span class="token punctuation">,</span>
        <span class="token property">"captureName"</span> <span class="token operator">:</span> <span class="token string">"ProducerConsumerQueue::_mutex"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div></span></div><nav class="u67xr01"><a class="u67xr02" href="/blog/005-dictionary-on-generics/"><span class="u67xr03">Previous</span><span class="u67xr04">Unlocking the Power of Generics: Simulating Dictionary Behavior in C#</span></a><a class="u67xr02" href="/blog/007-fixing-csharp-type-pattern-matching/"><span class="u67xr03">Next</span><span class="u67xr04">Fixing C# type pattern-matching</span></a></nav></div><div class="y0ya850"><p>Hi, I&#x27;m <b>Aleksey</b>!</p><p>I&#x27;m a <span class="y0ya851">Senior Software Engineer</span> <!-- -->with a focus on distributed and high-load systems. I work with <b>С#</b>,<!-- --> <b>Go</b> and <b>Kotlin</b>. Check out my<!-- --> <a href="https://www.linkedin.com/in/dev-alexey-maltsev/">LinkedIn</a> for my latest experience and my<!-- --> <a href="https://github.com/AxelUser">GitHub</a> for projects.</p></div><footer><small>© <!-- -->2024<!-- --> <!-- -->Alexey Maltsev</small></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/006-how-to-get-status-of-mongodb-operation/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-e9c56942b48050602512.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-647ed45c9ac6e806db98.js\"],\"component---src-pages-art-tsx\":[\"/component---src-pages-art-tsx-1c753bdf687a155e1a51.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-7d0aedbb920701b972e5.js\"],\"component---src-templates-art-collection-tsx\":[\"/component---src-templates-art-collection-tsx-2d374da9d5c293f65b83.js\"],\"component---src-templates-blog-post-tsx-content-file-path-content-blog-001-binary-shifts-for-flags-index-md\":[\"/component---src-templates-blog-post-tsx-content-file-path-content-blog-001-binary-shifts-for-flags-index-md-822aa4a1f633af9443ca.js\"],\"component---src-templates-blog-post-tsx-content-file-path-content-blog-002-callermembername-attribute-for-logging-index-md\":[\"/component---src-templates-blog-post-tsx-content-file-path-content-blog-002-callermembername-attribute-for-logging-index-md-3ce8651d7a4c8cb9ab11.js\"],\"component---src-templates-blog-post-tsx-content-file-path-content-blog-003-internals-visible-for-testing-index-md\":[\"/component---src-templates-blog-post-tsx-content-file-path-content-blog-003-internals-visible-for-testing-index-md-a81f1f2182430cc3c63f.js\"],\"component---src-templates-blog-post-tsx-content-file-path-content-blog-004-deconstructors-index-md\":[\"/component---src-templates-blog-post-tsx-content-file-path-content-blog-004-deconstructors-index-md-2723b9c121b1f21a9384.js\"],\"component---src-templates-blog-post-tsx-content-file-path-content-blog-005-dictionary-on-generics-index-md\":[\"/component---src-templates-blog-post-tsx-content-file-path-content-blog-005-dictionary-on-generics-index-md-fb6f10bca21d4e8f45c6.js\"],\"component---src-templates-blog-post-tsx-content-file-path-content-blog-006-how-to-get-status-of-mongodb-operation-index-md\":[\"/component---src-templates-blog-post-tsx-content-file-path-content-blog-006-how-to-get-status-of-mongodb-operation-index-md-2490b011035021d3e758.js\"],\"component---src-templates-blog-post-tsx-content-file-path-content-blog-007-fixing-csharp-type-pattern-matching-index-md\":[\"/component---src-templates-blog-post-tsx-content-file-path-content-blog-007-fixing-csharp-type-pattern-matching-index-md-31d9e7d21573e6dcf9af.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="297a022da6461b56d41f";</script><script src="/webpack-runtime-35e7cf083f5e72d285da.js" async></script><script src="/framework-583dd6f458a3b36520fb.js" async></script><script src="/app-e9c56942b48050602512.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>